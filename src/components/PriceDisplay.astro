---
/**
 * PriceDisplay.astro — Affiche le prix Amazon à jour depuis prices.json
 *
 * Au build, lit data/prices.json (généré par price-updater.js).
 * Si le prix n'est pas trouvé, affiche le prix de fallback.
 *
 * Usage:
 *   <PriceDisplay asin="B09C6J4WCS" fallback="499€" />
 */

export interface Props {
  asin: string;
  fallback?: string;          // Prix affiché si prices.json absent
  showSavings?: boolean;      // Affiche la réduction si dispo
  showPrime?: boolean;        // Badge Prime si éligible
  compact?: boolean;          // Affichage compact (sans badge)
}

const { asin, fallback = 'Voir le prix', showSavings = true, showPrime = true, compact = false } = Astro.props;

// Lecture de prices.json au build
let priceData = null;
let isMock = false;

try {
  // Path relatif depuis la racine du projet Astro
  const pricesRaw = await import('../../../homeoffice-affiliate/data/prices.json', {
    assert: { type: 'json' }
  }).catch(() => null);

  if (pricesRaw && pricesRaw.default[asin]) {
    priceData = pricesRaw.default[asin];
    isMock = priceData.isMock;
  }
} catch (e) {
  // prices.json absent — mode fallback
}

const price = priceData?.priceFormatted || fallback;
const originalPrice = priceData?.originalPriceFormatted;
const savings = priceData?.savingsFormatted;
const isPrime = priceData?.isPrime;
const lastUpdated = priceData?.lastUpdated
  ? new Date(priceData.lastUpdated).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })
  : null;
---

<div class={`price-display ${compact ? 'inline-flex items-center gap-2' : ''}`}>
  <!-- Prix principal -->
  <div class={compact ? 'flex items-center gap-2' : 'flex items-end gap-3 flex-wrap'}>
    <span class={`font-display font-bold text-ink ${compact ? 'text-lg' : 'text-3xl'}`}>
      {price}
    </span>

    {originalPrice && showSavings && (
      <span class={`text-ink-muted line-through ${compact ? 'text-sm' : 'text-lg'}`}>
        {originalPrice}
      </span>
    )}

    {savings && showSavings && !compact && (
      <span class="inline-flex items-center px-2 py-0.5 rounded-lg bg-red-100 text-red-700 text-sm font-semibold">
        -{savings} économisé
      </span>
    )}
  </div>

  <!-- Badges -->
  {!compact && (
    <div class="flex items-center gap-2 mt-1.5">
      {isPrime && showPrime && (
        <span class="inline-flex items-center gap-1 text-xs font-semibold text-blue-700 bg-blue-50 border border-blue-200 px-2 py-0.5 rounded-full">
          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
          </svg>
          Prime
        </span>
      )}

      {lastUpdated && !isMock && (
        <span class="text-xs text-ink-muted">
          Mis à jour le {lastUpdated}
        </span>
      )}

      {isMock && (
        <span class="text-xs text-amber-600 bg-amber-50 px-2 py-0.5 rounded-full">
          Prix indicatif — vérifier sur Amazon
        </span>
      )}
    </div>
  )}
</div>
